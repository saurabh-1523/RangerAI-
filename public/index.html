<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranger AI</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* CSS Variables for Theme Switching */
        :root {
            --bg-color: #000;
            --text-color: #f0f0f0;
            --accent-color: #8a2be2;
            --card-bg: rgba(30, 30, 30, 0.7);
            --nav-bg: rgba(20, 20, 20, 0.8);
            --border-radius: 12px;
            --blur-amount: 10px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Light Mode Overrides */
        [data-theme="light"] {
            --bg-color: #fefefe;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.7);
            --nav-bg: rgba(240, 240, 240, 0.8);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* Glassmorphism Effect */
        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px;
            background: var(--nav-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            z-index: 100;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }

        .sidebar.closed {
            transform: translateX(-100%);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            color: var(--accent-color);
            font-weight: bold;
            font-size: 1.5rem;
        }

        .logo i {
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 15px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-link i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--accent-color);
            color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: margin 0.3s;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background-color: rgba(138, 43, 226, 0.2);
        }

        /* Hamburger Menu */
        .hamburger {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .hamburger:hover {
            background-color: rgba(138, 43, 226, 0.2);
        }

        /* Tile Grid Layout */
        .tile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tile {
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .tile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tile-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .tile-icon {
            color: var(--accent-color);
            font-size: 1.5rem;
        }

        /* Point Calculator Styles */
        .calculator {
            max-width: 500px;
            margin: 0 auto;
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn {
            padding: 12px 25px;
            border-radius: var(--border-radius);
            border: none;
            background-color: var(--accent-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 220px;
            width: auto;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background-color: #7b1fa2;
            transform: translateY(-2px);
        }

        .btn-block {
            width: 100%;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-color);
            display: none;
        }

        /* Match Cards */
        .match-card {
            display: flex;
            flex-direction: column;
        }

        .match-teams {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .team {
            display: flex;
            align-items: center;
        }

        .team-logo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: rgba(138, 43, 226, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vs {
            align-self: center;
            padding: 0 15px;
            font-weight: bold;
        }

        .match-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Announcement Cards */
        .announcement-date {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
        }

        .announcement-content {
            line-height: 1.6;
        }

        /* Wallet Card */
        .wallet-balance {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
            text-align: center;
            margin: 20px 0;
        }

        .wallet-actions {
            display: flex;
            gap: 10px;
        }

        /* Support Form */
        .support-form .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .hamburger {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .tile-grid {
                grid-template-columns: 1fr;
            }

            .wallet-actions {
                flex-direction: column;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tile {
            animation: fadeIn 0.5s ease forwards;
        }

        .tile:nth-child(1) { animation-delay: 0.1s; }
        .tile:nth-child(2) { animation-delay: 0.2s; }
        .tile:nth-child(3) { animation-delay: 0.3s; }
        .tile:nth-child(4) { animation-delay: 0.4s; }
        .tile:nth-child(5) { animation-delay: 0.5s; }
        .tile:nth-child(6) { animation-delay: 0.6s; }

        /* Page-specific styles */
        #home-page .hero {
            text-align: center;
            padding: 50px 20px;
            margin-bottom: 30px;
        }

        #home-page .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        #home-page .hero p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }

        /* Hide all pages by default */
        .page {
            display: none;
        }

        /* Show active page */
        .page.active {
            display: block;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar glass" id="sidebar">
        <div class="logo">
            
            <span>Ranger.AI</span>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
            </li>
            <!-- <li class="nav-item">
                <a href="#" class="nav-link" data-page="matches">
                    <i class="fas fa-trophy"></i>
                    <span>Matches</span>
                </a>
            </li> -->
            <li class="nav-item">
                <a href="#" class="nav-link" data-page="announcement">
                    <i class="fas fa-bullhorn"></i>
                    <span>Announcements</span>
                </a>
            </li>
           
            <li class="nav-item">
    <a href="#" class="nav-link" data-page="ranger">
        <i class="fas fa-robot"></i>
        <span>Ranger Modal</span>
    </a>
</li>

            <li class="nav-item">
                <a href="#" class="nav-link" data-page="support">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-page="terms">
                    <i class="fas fa-file-contract"></i>
                    <span>Terms</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <div class="header">
            <button class="hamburger" id="hamburger">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="page-title" id="page-title">Home</h1>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Home Page -->
        <div class="page active" id="home-page">
            <section class="hero glass">
                <h1>Tournament Point Calculator</h1>
                <p>Calculate match points, track tournament progress, and manage your esports wallet all in one place.</p>
                <button class="btn" id="get-started-btn">Get Started</button>
            </section>
        </div>

        <!-- Matches Page -->
        <!-- The Matches page and its content have been removed. -->

        <!-- Announcements Page -->
        <div class="page" id="announcement-page">
            <h2 class="section-title">Latest Announcements</h2>
            <div class="tile-grid">
                <div class="tile glass">
                    <div class="tile-header">
                        <h2 class="tile-title">Happy Birthday</h2>
                        <i class="fas fa-bullhorn tile-icon"></i>
                    </div>
                    <div class="announcement-date">July 29, 2028</div>
                    <div class="announcement-content">
                        <p>please bring gifts</p>
                    </div>
                </div>

                <div class="tile glass">
                    <div class="tile-header">
                        <h2 class="tile-title">Niyam Kanoon</h2>
                        <i class="fas fa-bullhorn tile-icon"></i>
                    </div>
                    <div class="announcement-date">June 50, 2073</div>
                    <div class="announcement-content">
                        <p>Will be settled</p>
                    </div>
                </div>

                <div class="tile glass">
                    <div class="tile-header">
                        <h2 class="tile-title">Hello</h2>
                        <i class="fas fa-bullhorn tile-icon"></i>
                    </div>
                    <div class="announcement-date">May 45, 2089</div>
                    <div class="announcement-content">
                        <p>yaha bhii</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Page -->
        <div class="page" id="wallet-page">
            <div class="tile glass" style="max-width: 500px; margin: 0 auto;">
                <div class="tile-header">
                    <h2 class="tile-title">Your Wallet</h2>
                    <i class="fas fa-wallet tile-icon"></i>
                </div>
                <div class="wallet-balance">
                    â‚¹1,245.75
                </div>
                <div class="wallet-actions">
                    <button class="btn" style="flex: 1;">
                        <i class="fas fa-plus"></i> Deposit
                    </button>
                    <button class="btn" style="flex: 1;">
                        <i class="fas fa-minus"></i> Withdraw
                    </button>
                </div>
            </div>

            <h2 class="section-title" style="margin-top: 30px;">Transaction History</h2>
            <div class="tile-grid">
                <div class="tile glass">
                    <div class="tile-header">
                        <h2 class="tile-title">Recharged</h2>
                        <span style="color: #4caf50;">+â‚¹500.00</span>
                    </div>
                    <div class="announcement-date">June 10, 2025</div>
                    <div class="announcement-content">
                        
                    </div>
                </div>

                <div class="tile glass">
                    <div class="tile-header">
                        <h2 class="tile-title">Point Calculated</h2>
                        <span style="color: #f44336;">-â‚¹50.00</span>
                    </div>
                    <div class="announcement-date">May 25, 2025</div>
                    <div class="announcement-content">
                        
                    </div>
                </div>

                <div class="tile glass">
                    <div class="tile-header">
                        <h2 class="tile-title">Recharged</h2>
                        <span style="color: #4caf50;">+â‚¹200.00</span>
                    </div>
                    <div class="announcement-date">May 20, 2023</div>
                    <div class="announcement-content">
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="page" id="ranger-page">
    <div class="tile glass">
        <div class="tile-header">
            <h2 class="tile-title">Ranger Modal - Step 1: Combined Slotlist</h2>
            <i class="fas fa-upload tile-icon"></i>
        </div>

        <div class="form-group">
            <label class="form-label">Upload Slotlist Poster (Team Names)</label>
            <input type="file" id="slotlist-poster" class="form-input" accept="image/*">
        </div>

        <div class="form-group">
            <label class="form-label">Upload Slot Screenshots (Player Names)</label>
            <input type="file" id="slot-upload-combined" class="form-input" accept="image/*" multiple>
        </div>

        <button class="btn btn-block mt-3" onclick="processCombinedSlotlist()">Generate Final Slotlist CSV</button>
    </div>

    <div class="tile glass" style="margin-top: 30px;">
        <div class="tile-header">
            <h2 class="tile-title">Ranger Modal - Step 2: Match Result</h2>
            <i class="fas fa-trophy tile-icon"></i>
        </div>
        <div class="form-group">
            <label class="form-label">Upload Slotlist CSV (from Step 1)</label>
            <input type="file" id="slotlist-file" class="form-input" accept=".csv">
        </div>
        <div class="form-group">
            <label class="form-label">Matches Played</label>
            <input type="number" id="matches-played" class="form-input" min="1" value="1">
        </div>
        <div class="form-group">
            <label class="form-label">Group Name</label>
            <input type="text" id="group-name" class="form-input" value="G1">
        </div>
        <div class="form-group">
            <label class="form-label">Upload Match Result Screenshot(s)</label>
            <input type="file" id="result-upload" class="form-input" accept="image/*" multiple>
            <button class="btn btn-block mt-3" onclick="processResultScreenshots()">Generate Match Result CSV</button>
        </div>
    </div>

    <div class="tile glass" id="csv-links" style="margin-top: 30px; display: none;">
        <div class="tile-header">
            <h2 class="tile-title">Download Your Files</h2>
            <i class="fas fa-download tile-icon"></i>
        </div>
        <!-- Add this loader HTML inside #csv-links, above the download buttons -->
<div id="csv-loader" style="display:none; text-align:center; margin-bottom:16px;">
  <i class="fas fa-spinner fa-spin" style="font-size:2rem; color:var(--accent-color);"></i>
  <div style="margin-top:8px;">Processing...</div>
</div>
        <a id="slot-csv-link" class="btn mt-4" download>Download Slotlist CSV</a>
        <a id="result-csv-link" class="btn mt-3" style="display:none;" download>Download Match Result CSV</a>
    </div>
</div>


        <!-- Support Page -->
        <div class="page" id="support-page">
            <div class="tile-grid">
                <div class="tile glass">
                    <div class="tile-header">
                        <h2 class="tile-title">Frequently Asked Questions</h2>
                        <i class="fas fa-question-circle tile-icon"></i>
                    </div>
                    <div class="announcement-content">
                        <h3 style="margin: 15px 0 10px;">How are you?</h3>
                        <p>Iâ€™m all goodâ€”unless someone fakes a wallet issue againðŸ˜…</p>
                        
                        <h3 style="margin: 15px 0 10px;">Ghar pe sb theek?</h3>
                        <p>Sab badhiya, bas koi refund maangne na aa jaye. Aap sunao?</p>
                        
                        <h3 style="margin: 15px 0 10px;">100 bhej momos khana hai</h3>
                        <p>Bhai wallet mein paise dikh nahi rahe, aur yaha refund ka option bhi nahi. Momos toh door ki baat hai. ðŸ¥².</p>
                    </div>
                </div>

                <div class="tile glass support-form">
                    <div class="tile-header">
                        <h2 class="tile-title">Contact Support</h2>
                        <i class="fas fa-headset tile-icon"></i>
                    </div>
                    <form id="support-form">
                        <div class="form-group">
                            <label for="name" class="form-label">Your Name</label>
                            <input type="text" id="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" id="subject" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="message" class="form-label">Message</label>
                            <textarea id="message" class="form-input" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-block">Send Message</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Terms Page -->
        <div class="page" id="terms-page">
            <div class="tile glass">
                <div class="tile-header">
                    <h2 class="tile-title">Terms & Conditions</h2>
                    <i class="fas fa-file-contract tile-icon"></i>
                </div>
                <div class="announcement-content" style="max-height: 500px; overflow-y: auto;">
                    <h3 style="margin: 20px 0 10px;">1. General Terms</h3>
                    <p>By accessing RANGERPT Modal, you acknowledge and agree to comply with these Terms & Conditions. These Terms apply to all users, without exception.</p>
                    
                    <h3 style="margin: 20px 0 10px;">2. Eligibility</h3>
                    <p>You must be at least 18 years of age to use this service, as it involves wallet-based transactions (real money). By using the platform, you confirm that you meet this age requirement.</p>
                    
                    <h3 style="margin: 20px 0 10px;">3. Account Responsibility</h3>
                    <p>You are solely responsible for maintaining the confidentiality of your account credentials, including your password. All activity conducted under your account is your responsibility. Please notify us immediately if you suspect unauthorized access.</p>
                    
                    <h3 style="margin: 20px 0 10px;">4. Prohibited conduct</h3>
                    <p>Any attempt to misuse, exploit, or interfere with the platformâ€”including fraudulent behavior, false claims, or attempts to manipulate wallet transactionsâ€”may result in immediate suspension or termination of your account.</p>
                    
                    <h3 style="margin: 20px 0 10px;">5. Fraud and misuse policies</h3>
                    <p>Submitting false reports, such as claiming wallet deductions without receiving PT (points), will be considered fraudulent behavior. In such cases, we reserve the right to suspend your account and confiscate your wallet balance without prior notice.</p>
                    
                    <h3 style="margin: 20px 0 10px;">6. Refund Policy</h3>
                    <p>All transactions made on RANGERPT Modal are final. No refunds will be issued under any circumstances. Please review your actions carefully before making a transaction.</p>
                    
                    <h3 style="margin: 20px 0 10px;">7. Limitation of Liability</h3>
                    <p>RANGERPT Modal is not liable for any indirect, incidental, special, consequential, or punitive damages arising from your use ofâ€”or inability to useâ€”the service, including but not limited to loss of data, funds, or business interruption.</p>
                    
                    <h3 style="margin: 20px 0 10px;">8. Changes to Terms</h3>
                    <p>We reserve the right to update or modify these Terms at any time. Any changes will be effective immediately upon posting. Continued use of the service after changes are made signifies your acceptance of the revised Terms.</p>
                </div>
            </div>
        </div>

        <div class="footer glass">
            <p>&copy; Made at CreativeX. 2025 All Right Reserved</p>
        </div>
    </main>
    <script>

   // DOM Elements
const sidebar = document.getElementById('sidebar');
const hamburger = document.getElementById('hamburger');
const mainContent = document.getElementById('main-content');
const themeToggle = document.getElementById('theme-toggle');
const navLinks = document.querySelectorAll('.nav-link');
const pages = document.querySelectorAll('.page');
const pageTitle = document.getElementById('page-title');
const supportForm = document.getElementById('support-form');

// Mobile Menu Toggle
hamburger.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    mainContent.classList.toggle('expanded');
});

// Theme Toggle
themeToggle.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    if (currentTheme === 'light') {
        document.documentElement.removeAttribute('data-theme');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', 'dark');
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem('theme', 'light');
    }
});

// Check for saved theme preference
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
}

// Navigation
navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remove active class from all links
        navLinks.forEach(navLink => navLink.classList.remove('active'));
        
        // Add active class to clicked link
        link.classList.add('active');
        
        // Hide all pages
        pages.forEach(page => page.classList.remove('active'));
        
        // Show selected page
        const pageId = link.getAttribute('data-page');
        document.getElementById(`${pageId}-page`).classList.add('active');
        
        // Update page title
        pageTitle.textContent = link.querySelector('span').textContent;
        
        // Close sidebar on mobile
        if (window.innerWidth < 992) {
            sidebar.classList.remove('open');
            mainContent.classList.remove('expanded');
        }
    });
});

// Support Form Submission
supportForm.addEventListener('submit', (e) => {
    e.preventDefault();
    alert('Thank you for your message! Our support team will get back to you soon.');
    supportForm.reset();
});

// Close sidebar when clicking outside on mobile
document.addEventListener('click', (e) => {
    if (window.innerWidth < 992 && !sidebar.contains(e.target) && !hamburger.contains(e.target)) {
        sidebar.classList.remove('open');
        mainContent.classList.remove('expanded');
    }
});

// Convert file to Base64 string
function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Generic function to call backend API
async function callBackendAPI(prompt, imageFile) {
    const formData = new FormData();
    formData.append('prompt', prompt);
    if (imageFile) {
        formData.append('image', imageFile);
    }

    try {
        const response = await fetch('/api/openai', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
    } catch (error) {
        console.error('Error calling backend API:', error);
        throw error;
    }
}

async function processSlotImage() {
    const files = document.getElementById('slot-upload').files;
    if (!files.length) return alert("Please upload slot screenshots.");

    document.getElementById("csv-links").style.display = "block";
    document.getElementById("csv-loader").style.display = "block";
    document.getElementById("slot-csv-link").style.display = "none";

    const prompt = `
You are a screenshot parser for an esports slot management system.
Each image shows slot boxes. Each box contains:
1. A slot number (e.g., 12, 13, etc.)
2. Up to four player names below the slot number.

Extract these from each image and return:
[
  { "slot": 12, "players": ["Player1", "Player2", "Player3", "Player4"] },
  ...
]

Keep player names exactly as shown. Return only valid JSON.
`;

    const allEntries = [];

    for (let file of files) {
        try {
            const result = await callBackendAPI(prompt, file);
            let content = result.choices[0]?.message?.content || "";
            content = content.replace(/```json|```/g, "").trim();

            try {
                const parsed = JSON.parse(content);
                if (Array.isArray(parsed)) {
                    allEntries.push(...parsed);
                }
            } catch (e) {
                console.warn("Failed to parse this file:", file.name, e);
            }
        } catch (error) {
            console.error("Error processing file:", file.name, error);
            alert(`Error processing ${file.name}: ${error.message}`);
        }
    }

    // Process and create CSV as before
    const slotMap = new Map();
    allEntries.forEach(entry => {
        slotMap.set(Number(entry.slot), entry);
    });

    const sortedSlots = Array.from(slotMap.keys()).sort((a, b) => a - b);
    const csvData = [["Slot", "Player 1", "Player 2", "Player 3", "Player 4"]];
    
    sortedSlots.forEach(slotNum => {
        const entry = slotMap.get(slotNum);
        const row = [entry.slot];
        for (let i = 0; i < 4; i++) {
            row.push(entry.players[i] || "");
        }
        csvData.push(row);
    });

    const csv = Papa.unparse(csvData);
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const link = document.getElementById("slot-csv-link");
    link.href = url;
    link.download = "combined_slotlist.csv";

    document.getElementById("csv-loader").style.display = "none";
    link.style.display = "inline-block";
}

async function processResultScreenshots() {
    const resultFiles = document.getElementById("result-upload").files;
    const slotCsvFile = document.getElementById("slotlist-file").files[0];
    const matchesPlayed = document.getElementById("matches-played")?.value || "1";
    const groupName = document.getElementById("group-name")?.value || "";

    if (!slotCsvFile) return alert("Please upload the final slotlist CSV.");
    if (!resultFiles.length) return alert("Please upload match result screenshots.");

    document.getElementById("csv-links").style.display = "block";
    document.getElementById("csv-loader").style.display = "block";
    document.getElementById("result-csv-link").style.display = "none";

    const csvText = await slotCsvFile.text();
    const slotData = Papa.parse(csvText, { header: true }).data;

    // Create player mappings
    const playerToTeam = {};
    const playerToSlot = {};
    slotData.forEach(row => {
        const team = row["Team Name"]?.trim();
        const slot = row["Slot"] || row["SLOT NUMBER"] || row["Slot Number"] || row["SLOT"];
        for (let i = 1; i <= 4; i++) {
            const player = row[`Player ${i}`]?.trim();
            if (player) {
                playerToTeam[player] = team;
                playerToSlot[player] = slot;
            }
        }
    });

    const prompt = `
You're an esports result parser. Each image shows match result boxes.
Each box contains:
1. Placement number (1 to 25)
2. 4 player names
3. Finish counts like "3 finishes"

Return valid JSON:
[
  {
    "placement": 1,
    "players": ["A", "B", "C", "D"],
    "kills": 12
  }
]
`;

    const allResults = [];

    for (let file of resultFiles) {
        try {
            const result = await callBackendAPI(prompt, file);
            let raw = result.choices[0]?.message?.content || "";
            raw = raw.replace(/```json|```/g, "").trim();

            try {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) allResults.push(...parsed);
            } catch {
                console.warn("Failed to parse GPT match result.");
            }
        } catch (error) {
            console.error("Error processing result file:", file.name, error);
            alert(`Error processing ${file.name}: ${error.message}`);
        }
    }

    // Process results and create CSV as before
    const placementPoints = { 1: 10, 2: 6, 3: 5, 4: 4, 5: 3, 6: 2, 7: 1, 8: 1 };
    const seenTeams = new Set();
    const finalResults = [];

    allResults.forEach(team => {
        const players = team.players || [];
        let teamName = "Unknown";
        let slotNumber = "";

        for (let p of players) {
            if (playerToTeam[p]) {
                teamName = playerToTeam[p];
                slotNumber = playerToSlot[p];
                break;
            }
        }

        if (seenTeams.has(teamName)) return;
        seenTeams.add(teamName);

        const placement = team.placement;
        const finishPoint = team.kills || 0;
        const placementPoint = placementPoints[placement] || 0;
        const totalPoint = placementPoint + finishPoint;
        const win = placement === 1 ? 1 : 0;

        finalResults.push({
            teamName,
            win,
            matchesPlayed,
            finishPoint,
            placementPoint,
            totalPoint,
            groupName,
            slotNumber
        });
    });

    finalResults.sort((a, b) => {
        if (a.placementPoint !== b.placementPoint) return b.placementPoint - a.placementPoint;
        if (a.totalPoint !== b.totalPoint) return b.totalPoint - a.totalPoint;
        return a.teamName.localeCompare(b.teamName);
    });

    // Create CSV
    const teamResultMap = {};
    finalResults.forEach(entry => teamResultMap[entry.teamName] = entry);

    const csvData = [["TEAM NAME", "WIN", "MATCHES PLAYED", "PLACEMENT POINT", "FINISH POINT", "TOTAL POINT", "GROUP NAME", "SLOT NUMBER"]];
    
    const teamsInSlotlist = new Set();
    slotData.forEach(row => {
        const teamName = row["Team Name"]?.trim() || row["TEAM NAME"]?.trim() || "Unknown";
        const slotNumber = row["Slot"] || row["SLOT NUMBER"] || row["Slot Number"] || row["SLOT"] || "";
        teamsInSlotlist.add(teamName);

        const result = teamResultMap[teamName] || {
            win: 0,
            matchesPlayed,
            finishPoint: 0,
            placementPoint: 0,
            totalPoint: 0,
            groupName,
            slotNumber
        };

        csvData.push([
            teamName,
            result.win,
            result.matchesPlayed,
            result.placementPoint,
            result.finishPoint,
            result.totalPoint,
            result.groupName,
            slotNumber
        ]);
    });

    // Add any teams in results but not in slotlist
    for (const teamName in teamResultMap) {
        if (!teamsInSlotlist.has(teamName)) {
            const entry = teamResultMap[teamName];
            csvData.push([
                teamName,
                entry.win,
                entry.matchesPlayed,
                entry.placementPoint,
                entry.finishPoint,
                entry.totalPoint,
                entry.groupName,
                entry.slotNumber
            ]);
        }
    }

    const csv = Papa.unparse(csvData);
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const link = document.getElementById("result-csv-link");
    link.href = url;
    link.download = "Final result.csv";
    document.getElementById("csv-loader").style.display = "none";
    link.style.display = "inline-block";
}

async function processCombinedSlotlist() {
    const posterFile = document.getElementById("slotlist-poster").files[0];
    const slotFiles = document.getElementById("slot-upload-combined").files;

    if (!posterFile) return alert("Please upload the slotlist poster.");
    if (!slotFiles.length) return alert("Please upload the slot screenshots.");

    document.getElementById("csv-links").style.display = "block";
    document.getElementById("csv-loader").style.display = "block";
    document.getElementById("slot-csv-link").style.display = "none";

    // Process poster
    const posterPrompt = `
You are an esports image reader. The image shows a list of slot numbers and team names.
Extract them in this format:

[
  { "slot": 3, "team": "F8" },
  { "slot": 4, "team": "TEAM EL PRIMO" }
]

Return only valid JSON.
`;

    let teamList = [];
    try {
        const posterResult = await callBackendAPI(posterPrompt, posterFile);
        let teamListRaw = posterResult.choices[0]?.message?.content || "";
        teamListRaw = teamListRaw.replace(/```json|```/g, "").trim();
        teamList = JSON.parse(teamListRaw);
    } catch (e) {
        document.getElementById("csv-loader").style.display = "none";
        return alert("Failed to read team names from slotlist poster.");
    }

    // Process slot screenshots
    const slotPrompt = `
You are a screenshot parser for an esports slot system.
Each image shows boxes with:
- A slot number (e.g. 3, 11, 12, etc.)
- Up to four player names below it.

IMPORTANT: Be very careful to distinguish between slot numbers like 1 and 11, 2 and 12, etc. Do not confuse single and double digit slot numbers. Double-check that slot numbers are correct and match exactly as shown in the image.

Return valid JSON:
[
  { "slot": 3, "players": ["Player1", "Player2", "Player3", "Player4"] }
]
`;

    const allSlots = [];
    for (let file of slotFiles) {
        try {
            const slotResult = await callBackendAPI(slotPrompt, file);
            let raw = slotResult.choices[0]?.message?.content || "";
            raw = raw.replace(/```json|```/g, "").trim();
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) allSlots.push(...parsed);
        } catch (e) {
            console.warn("Failed to parse one slot screenshot:", e);
        }
    }

    // Merge data
    const teamMap = new Map();
    teamList.forEach(entry => teamMap.set(Number(entry.slot), entry.team));

    const merged = [];
    const seen = new Set();

    allSlots.forEach(entry => {
        const slot = Number(entry.slot);
        if (seen.has(slot)) return;
        seen.add(slot);
        const team = teamMap.get(slot) || "Unknown";
        merged.push([slot, team, ...(entry.players || [])]);
    });

    // Sort and create CSV
    merged.sort((a, b) => a[0] - b[0]);
    const csvData = [["Slot", "Team Name", "Player 1", "Player 2", "Player 3", "Player 4"]];
    
    merged.forEach(row => {
        const filled = [...row];
        while (filled.length < 6) filled.push("");
        csvData.push(filled);
    });

    const csv = Papa.unparse(csvData);
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const link = document.getElementById("slot-csv-link");
    link.href = url;
    link.download = "final_slotlist.csv";
    document.getElementById("csv-loader").style.display = "none";
    link.style.display = "inline-block";
}

// Link "Get Started" button to Ranger Modal page
document.getElementById('get-started-btn').addEventListener('click', function() {
    pages.forEach(page => page.classList.remove('active'));
    document.getElementById('ranger-page').classList.add('active');
    pageTitle.textContent = "Ranger Modal";
    navLinks.forEach(link => link.classList.remove('active'));
    document.querySelector('.nav-link[data-page="ranger"]').classList.add('active');
    async function callBackendAPI(prompt, imageFile) {
    const formData = new FormData();
    formData.append('prompt', prompt);
    
    if (imageFile) {
        // Validate file size before uploading
        if (imageFile.size > 10 * 1024 * 1024) { // 10MB
            throw new Error('Image file too large (max 10MB)');
        }
        formData.append('image', imageFile);
    }

    try {
        const response = await fetch('/api/openai', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            // Try to get error details from response
            let errorDetails = '';
            try {
                const errorData = await response.json();
                errorDetails = errorData.error || errorData.message || '';
            } catch (e) {}
            
            throw new Error(`Server error: ${response.status} ${response.statusText}. ${errorDetails}`);
        }

        return await response.json();
    } catch (error) {
        console.error('API Call Failed:', error);
        throw error;
    }
}
});
</script>
</body>
</html>
